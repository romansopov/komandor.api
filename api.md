### API ver. 1.0.0

- [Коды ошибок](#%D0%9A%D0%BE%D0%B4%D1%8B-%D0%BE%D1%88%D0%B8%D0%B1%D0%BE%D0%BA)
- [Аутентификация](#%D0%90%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F)
- - [Подтверждение аутентификации](#%D0%9F%D0%BE%D0%B4%D1%82%D0%B2%D0%B5%D1%80%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D0%B8)
- [Регистрация номера телефона](#%D0%A0%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%BD%D0%BE%D0%BC%D0%B5%D1%80%D0%B0-%D1%82%D0%B5%D0%BB%D0%B5%D1%84%D0%BE%D0%BD%D0%B0)
- - [Подтверждение телефона](#%D0%9F%D0%BE%D0%B4%D1%82%D0%B2%D0%B5%D1%80%D0%B6%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D1%82%D0%B5%D0%BB%D0%B5%D1%84%D0%BE%D0%BD%D0%B0)
- [Профиль](#%D0%9F%D1%80%D0%BE%D1%84%D0%B8%D0%BB%D1%8C)
- [Контакты](#%D0%9A%D0%BE%D0%BD%D1%82%D0%B0%D0%BA%D1%82%D1%8B)
- [Новый чат (контакт)](#%D0%9D%D0%BE%D0%B2%D1%8B%D0%B9-%D1%87%D0%B0%D1%82-%D0%BA%D0%BE%D0%BD%D1%82%D0%B0%D0%BA%D1%82)
- [Отправка сообщения](#%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F)
- - [Отправка в сокет](#%D0%9E%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0-%D0%B2-%D1%81%D0%BE%D0%BA%D0%B5%D1%82)
- [Получение сообщений, подписка на чаты](#%D0%9F%D0%BE%D0%BB%D1%83%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D0%B9-%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D0%BA%D0%B0-%D0%BD%D0%B0-%D1%87%D0%B0%D1%82%D1%8B)
- - [Сокет](#%D0%A1%D0%BE%D0%BA%D0%B5%D1%82)
- [Файлы](#%D0%A4%D0%B0%D0%B9%D0%BB%D1%8B)

Формат ответа:

```json
{
  "success": "true|false",
  "error": "Код ошибки если success = false",
  "data": "Отсутствует или объект/массив данных если success = true"
}
```

### Коды ошибок
* CommonError - Общая (неизвестная) ошибка
* DataError - Ошибка при получении данных
* MethodNotFound - Метод не найден
* AuthenticationFailed - Ошибка аутентификации
* NeedAuthentication - Требуется аутентификация
* SessionExpired - Срок действия сессии истек
* CertificateExpired - Срок действия сертификата истек
* IncorrectCode - Некорректный код подтверждения
* NeedRegisterPhone - Требуется указать мобильный телефон
* PhoneAlreadyRegistered - Телефон уже зарегистрирован
* WrongPassword - Некорректный пароль
* WrongContainer - Некорректный контейнер
* InvalidSchema - Ошибка проверки схемы запроса
* InvalidSignature - Недействительная подпись
* InvalidCertificate - Некорректный или недействительный сертификат
* InvalidResponse - Некорректный ответ
* SimpleSign - Ошибка простой подписи
* CryptoError - Ошибка крипто-модуля
* EncryptError - Ошибка шифрования
* DecryptError - Ошибка дешифрования
* NetworkError - Ошибка сети
* SMSError - Ошибка отправки СМС
* CreateChatError - Ошибка создания чата
* CreateChatKeysError - Ошибка создания ключей чата
* GetChatsError - Ошибка получения чатов

### Аутентификация

```
JSON /api/auth/
```

В первом запросе отправляем сертификат пользователя и простую подпись этого сертификата в форматах base64:

```json
{
  "cert": "base64",
  "sign": "base64"
}
```

Сервис проверяет сертификат, корректность подписи и возвращает объект с данными для подтверждения аутентификации:

```json
{
  "success": true,
  "data": {
    "nonce": "bOx8uVvyKAKo4f/cBXHPeEE2SFyqkMjutU2z5Q34nFM=",
    "token": "99b082c6-979b-4646-9e85-60f30b1c37a7"
  }
}
```

#### Подтверждение аутентификации

```
JSON /api/confirmAuth/
```

Для подтверждения надо подписать `nonce` простой подписью и отправить второй запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "sign": "BRZjB74opJptKg4Mv5DYCmot+xdtiWRcH/rgSx+WViypiicgfV3HaZ5iI9561LpbikFGTUfZmpFBwYIlAmyCcg=="
}
```

Ответ:

```json
{
  "success": true,
  "data": {
    "needRegisterPhone": true
  }
}
```

### Регистрация номера телефона

```
JSON /api/registryPhone/
```

Если после успешной аутентификации свойство `needRegisterPhone = true` необходимо зарегистрировать номер мобильного телефона с подтверждением кодом из СМС.

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "phone": "+7 (123) 123-45-67"
}
```

В ответ получаем идентификатор код подтверждения:

```json
{
  "success": true,
  "data": {
    "id": 1234
  }
}
```

#### Подтверждение телефона

```
JSON /api/confirmPhone/
```

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "id": 1234,
  "code": 987654
}
```

### Профиль

```
JSON /api/profile/
```

Запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7"
}
```

Ответ:

```json
{
  "success": true,
  "data": {
    "pid": 451,
    "cid": 32,
    "type": 1,
    "name": "ФИО",
    "company": "Название организации|Индивидуальный предприниматель",
    "title": "Должность",
    "inn": "770123456789",
    "ogrn": "1234567890123",
    "snils": "12345678901",
    "phone": "79991234567",
    "photo": "base64:AAAAA=",
    "billing": {
      "balance": 299.00
    },
    "certificates": [{
      "id": 22,
      "cert": "base64"
    }]
  }
}
```

### Контакты

```
JSON /api/contacts/
```

Получение списка контактов или поиск по переданным номерам `phones`. Если в результате поиска контакта он уже добавлен, то будет передан идентификатор `chatId` и объект `key` с ключом шифрования для данного контакта.

Запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "phones": ["79991234567"]
}
```

Ответ:

```json
{
  "success": true,
  "data": [{
    "uid": 29,
    "pid": 33,
    "user": "ФИО",
    "name": "Название организации|Индивидуальный предприниматель|ФИО",
    "title": "Должность",
    "phone": "79991234567",
    "photo": "base64:AAAAA=",
    "type": 1,
    "certificates": [{
      "id": 22,
      "cert": "base64"
    }],
    "chatId": "91ec6ed7-aced-4251-bb01-55debd90ddb6",
    "chatType": 0,
    "chatName": "Название группы или канала",
    "key": {
      "id": 123,
      "key": "base64",
      "import": false,
      "cert": "base64"
    }
  }]
}
```

После получения списка контактов в случае поиска и если `chatId` и `key` равны `null` (контакт не добавлен в чат) то создаем сессионный ключ для контакта. Экспортируем ключ на все сертификаты пользователя и сертификаты контакта.

#### Новый чат (контакт)

```
JSON /api/createChat/
```

Новый чат создается перед первой отправкой сообщения и возвращает полный объект созданного чата. Чаты бывают трех типов: личный - 0, группа - 1, канал - 2.

- `cid` - идентификатор сертификата
- `pid` - идентификатор профиля
- `key` - зашифрованный (экспортированный) ключ

Запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "type": 0,
  "name": "Название группы или канала",
  "keys": [{
    "cid": 123,
    "pid": 456,
    "key": "base64"
  }]
}
```

После успешного создания чата возращает полный объект Контакта.

### Отправка сообщения

```
JSON /api/sendMessage/
SOCKET sendMessage
```

Запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "chat": "91ec6ed7-aced-4251-bb01-55debd90ddb6",
  "text": "base64",
  "type": "pdf",
  "data": "base64",
  "sign": "base64",
  "cms": "base64",
  "cid": 123
}
```

- `text` - зашифрованное простое текстовое сообщение в base64
- `type` - тип документа: txt, pdf, docx и т.д.
- `data` - зашифрованное содержимое файла в base64
- `sign` - простая подпись для `text`
- `cms` - CMS подпись для файла
- `cid` - идентификатор сертификата

#### Отправка в сокет

Для отправки сообщения в сокет передается такой же объект данных, но с дополнительным свойством `localId`. Локальный идентификатор сообщения нужен для отслеживания статуса отправки, он будет возвращен вместе с полным объектом сообщений в коллбэке. Сообщения рассылаются всем в чате кроме отправителя.

### Получение сообщений, подписка на чаты

```
JSON /api/messages/
SOCKET messages
SOCKET subscribe
SOCKET unsubscribe
```

Если передан `id` сообщения и направление `prev` или `next` будет возвращен массив из максимум 50 сообщений. Если `id` не передан то загружаются последние 50 сообщений чата. Если передан `type = "file"` буду загружены только сообщения с документами.

Запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "chat": "91ec6ed7-aced-4251-bb01-55debd90ddb6",
  "id": 123,
  "rel": "prev|next",
  "type": "file"
}
```
#### Сокет

Для получения сообщений в сокет `messages` необходимо подписываться на чаты событием `subscribe` передав ему идентификатор чата, например:

```js
socket.emit('subscribe', '91ec6ed7-aced-4251-bb01-55debd90ddb6')
```

Ответ:

```json
{
  "id": 123,
  "chat": "91ec6ed7-aced-4251-bb01-55debd90ddb6",
  "pid": 123,
  "cid": 123,
  "user": "ФИО",
  "data": "base64",
  "sign": "base64",
  "cms": "base64",
  "type": "txt",
  "file": "6d3cb099-4462-4d8d-b5e4-55b42a337b63"
}
```

- `id` - Идентификатор сообщения
- `chat` - Идентификатор чата
- `pid` - Идентификатор профиля отправителя сообщения
- `cid` - Идентификатор сертификата отправителя сообщения для проверки подписи
- `user` - ФИО отправителя
- `sign` - Простая подпись
- `cms` - CMS подпись
- `type` - Тип сообщения, txt - простой текст все остальное - файлы
- `file` - Идентификатор файла для скачивания

### Файлы

```
JSON /api/file/
```

Для получения (скачивания) зашифрованного файла, передаются идентификаторы чата и файла:

Запрос:

```json
{
  "token": "99b082c6-979b-4646-9e85-60f30b1c37a7",
  "chat": "91ec6ed7-aced-4251-bb01-55debd90ddb6",
  "file": "71ba30a2-3c2f-4470-bd7a-a75859219d47"
}
```

Ответ:

```json
{
  "content": "base64"
}
```
